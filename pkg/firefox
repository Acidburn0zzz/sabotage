[mirrors]
ftp://ftp.mozilla.org/pub/mozilla.org/firefox/releases/25.0/source/firefox-25.0.source.tar.bz2
http://releases.mozilla.org/pub/mozilla.org/firefox/releases/25.0/source/firefox-25.0.source.tar.bz2

[main]
filesize=127524815
sha512=debec2cc87da1e68739ddadcb35a027cf6f980471c85ea2e6a85f5b0b4861415659c74b5e57b6cb06bcdf6ecf4722e1c08d98a4256aefdf5bf285c9806f5a13f
tardir=mozilla-release

[deps]
libevent
gtk+2
alsa-lib
zip
zlib
libpng
bzip2
perl
python

[build]
patch -p1 < "$K"/firefox-virtualenv.patch || exit 1
patch -p1 < "$K"/firefox-getprotobyname_r.patch || exit 1
patch -p1 < "$K"/firefox-finite.patch || exit 1
patch -p1 < "$K"/firefox-gregor.patch || exit 1
patch -p1 < "$K"/firefox-profiler.patch || exit 1
patch -p1 < "$K"/firefox-hunspell.patch || exit 1

cat << EOF > mozconfig
mk_add_options MOZ_MAKE_FLAGS="-j$MAKE_THREADS"
ac_add_options --disable-dbus
ac_add_options --disable-necko-wifi
ac_add_options --disable-libnotify
ac_add_options --disable-jemalloc
ac_add_options --disable-replace-malloc
ac_add_options --disable-wrap-malloc

ac_add_options --disable-profiling
# this option breaks the build
#ac_add_options --disable-webspeech
# disabling ogg as the makefile forgets to add -logg -lvorbis
ac_add_options --disable-ogg


# GStreamer is necessary for H.264 video playback in HTML5 Video Player;
# to be enabled, also remember to set "media.gstreamer.enabled" to "true"
# in about:config. If you have installed GStreamer comment out this line:
ac_add_options --disable-gstreamer

# Uncomment these lines if you have installed optional dependencies:
#ac_add_options --enable-system-hunspell
#ac_add_options --enable-startup-notification

# Uncomment this line if you compiled Cairo with --enable-tee switch and want
# to use it instead of the bundled one:
#ac_add_options --enable-system-cairo

# If you have not installed Yasm then uncomment these 3 lines:
ac_add_options --disable-webm
ac_add_options --disable-webrtc
ac_add_options --disable-libjpeg-turbo

# If you have installed xulrunner uncomment the next two ac_add_options lines
# and check that the sdk will be set by running pkg-config in a subshell
# and has not become hardcoded or empty when you created this file
#ac_add_options --with-system-libxul
#ac_add_options --with-libxul-sdk=$(pkg-config --variable=sdkdir libxul)

# Comment out following options if you have not installed
# recommended dependencies:
#ac_add_options --enable-system-sqlite
ac_add_options --with-system-libevent
#ac_add_options --with-system-libvpx
#ac_add_options --with-system-nspr
#ac_add_options --with-system-nss

# It is recommended not to touch anything below this line
ac_add_options --prefix=/$butch_prefix
ac_add_options --enable-application=browser

ac_add_options --disable-crashreporter
ac_add_options --disable-installer
ac_add_options --disable-updater
ac_add_options --disable-debug
ac_add_options --disable-tests

ac_add_options --enable-optimize
ac_add_options --enable-strip
ac_add_options --enable-install-strip
ac_add_options --enable-gio
ac_add_options --enable-official-branding
ac_add_options --enable-safe-browsing
ac_add_options --enable-url-classifier

ac_add_options --enable-system-ffi
ac_add_options --enable-system-pixman

ac_add_options --with-pthreads

ac_add_options --with-system-bz2
#ac_add_options --with-system-jpeg
#ac_add_options --with-system-png
ac_add_options --with-system-zlib

mk_add_options MOZ_OBJDIR=@TOPSRCDIR@/firefox-build-dir
EOF
sed -i 's@ ""@@' browser/base/Makefile.in &&

mkdir -p include/sys
cat << EOF > include/sys/cdefs.h
#ifndef __P
#define __P(foo) foo
#endif
EOF

find . -name '*.[ch]' | xargs sed -i s'@#include <sys/cdefs.h>@#define __P(x) x@g'

CFLAGS="-D_GNU_SOURCE $optcflags -I$PWD/include" \
CXXFLAGS="-D_GNU_SOURCE $optcflags -I$PWD/include" \
make -f client.mk || exit 1

CFLAGS="-D_GNU_SOURCE $optcflags -I$PWD/include" \
CXXFLAGS="-D_GNU_SOURCE $optcflags -I$PWD/include" \
make -C firefox-build-dir/browser/installer || exit 1

# TODO : figure out how to install stuff correctly
# the created tarball is unusable, as gnu tar is assumed
# probably we can just copy everything under firefox-build-dir/dist
# into "$butch_install_dir""$butch_prefix"
# for now, the browser can be started like this:
# cd /src/build/firefox/mozilla-release/firefox-build-dir/dist
# LD_LIBRARY_PATH=lib/ bin/firefox

#CFLAGS="-D_GNU_SOURCE $optcflags" LDFLAGS="$optldflags" \
#  ./configure -C --prefix="$butch_prefix" || exit 1

#make -j$MAKE_THREADS || exit 1
#make DESTDIR="$butch_install_dir" install || exit 1
